version: "3.9"
services:

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    # network_mode: "host"
    volumes:
    - ./etc/otel-config.yaml:/etc/otel-config.yaml:Z
    - /proc:/host/proc:ro
    - /sys:/host/sys:ro
    - /:/host:ro # mount the entire host FS so /proc etc. are visible for mac
    command: [ "--config", "/etc/otel-config.yaml" ]
    ports:
    - "9464:9464" # Prometheus exporter
    networks:
      edge-network:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: iceberg_user
      POSTGRES_PASSWORD: iceberg_pass
      POSTGRES_DB: iceberg_metadata
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      edge-network:

  minio:
    image: minio/minio
    container_name: minio1
    environment:
      - MINIO_ROOT_USER=minioAdmin
      - MINIO_ROOT_PASSWORD=minio1234
      # - MINIO_DOMAIN=minio

    ports:
      - 9001:9001
      - 9000:9000
      - 9002:9002
    command: ["server", "/data", "--console-address", ":9002"]
    networks:
      edge-network:
        aliases:
          - warehouse.minio
  mc:
    depends_on:
      - minio
    image: minio/mc
    container_name: mc
    
    environment:
      - AWS_ACCESS_KEY_ID=minioAdmin
      - AWS_SECRET_ACCESS_KEY=minio1234
      - AWS_REGION=us-east-1
    networks:
      edge-network:

    entrypoint: >
      /bin/sh -c "
      sleep 10 && 
      mc alias set minio http://minio:9000 minioAdmin minio1234 && 
      mc mb minio/warehouse || echo 'source Bucket already exists' &&
      mc mb minio/edge || echo 'source Bucket already exists';
      "
  iceberg-catalog:
    # image: apache/iceberg-rest-fixture:latest
    # image: quay.io/zagaos/iceberg-custom-rest:1.0
    
    build:
      context: ./iceberg  # ðŸ‘ˆ context should match the folder containing the Dockerfile
      dockerfile: Dockerfile
      # context: ./iceberg
    container_name: iceberg
    
    # Remove the direct port exposure since we'll use Nginx
    environment:
      - AWS_ACCESS_KEY_ID=minioAdmin
      - AWS_SECRET_ACCESS_KEY=minio1234
      - AWS_REGION=us-east-1
      - CATALOG_WAREHOUSE=s3://warehouse/
      - CATALOG_IO__IMPL=org.apache.iceberg.aws.s3.S3FileIO
      - CATALOG_S3_ENDPOINT=http://minio:9000

      - CATALOG_CATALOG__IMPL=org.apache.iceberg.jdbc.JdbcCatalog
      - CATALOG_URI=jdbc:postgresql://postgres:5432/iceberg_metadata
      - CATALOG_JDBC_USER=iceberg_user
      - CATALOG_JDBC_PASSWORD=iceberg_pass
      - CATALOG_JDBC_DRIVER=org.postgresql.Driver
      - REST_PORT=8181
    ports:
      - 8181:8181
    depends_on:
      - postgres
      - minio
      - mc
    networks:
      edge-network:
  prometheus:
    image: prom/prometheus:latest
    volumes:
    - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
    - "9090:9090"
    networks:
        edge-network:
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
    - "3000:3000" # Grafana UI
    environment:
    - GF_SECURITY_ADMIN_USER=admin
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_DASHBOARDS_JSON_ENABLED=true
    - GF_DASHBOARDS_JSON_PATH=/var/lib/grafana/dashboards
    volumes:
    - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    - ./grafana/grafana-data:/var/lib/grafana # persist Grafana DB and config

    depends_on:
    - prometheus
    networks:
        edge-network:
  edge-exporter:
    build: ./otel-exporter
    container_name: edge-exporter
    ports:
      - "50051:50051"  # gRPC
      - "8000:8000"  # gRPC
    environment:

      ICEBERG_WAREHOUSE: "s3://warehouse"
      S3_ACCESS_KEY: "minioAdmin"
      S3_SECRET_KEY: "minio1234"
      S3_PATH_STYLE: "true"
      S3_REGION: "us-east-1"
      ICEBERG_REST_URI: "http://iceberg-catalog:8181"

      # PYICEBERG_CATALOG__EDGE__URI: "http://iceberg-catalog:8181"
      # PYICEBERG_CATALOG__EDGE__S3__ACCESS_KEY_ID: "minioAdmin"
      # PYICEBERG_CATALOG__EDGE__S3__SECRET_ACCESS_KEY: "minio1234"
      # PYICEBERG_CATALOG__EDGE__S3__ENDPOINT: "http://minio:9000"
      # PYICEBERG_CATALOG__EDGE__S3__REGION: "us-west-2"
      # PYICEBERG_CATALOG__EDGE__PY__IO_IMPL: "pyiceberg.io.fsspec.FsspecFileIO"
    networks:
      edge-network:
volumes:
  pgdata:

networks:
  edge-network:
    external: true